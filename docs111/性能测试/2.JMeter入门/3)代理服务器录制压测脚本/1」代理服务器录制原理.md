# 代理服务器录制原理

## 本章要点
1. 录制压测脚本原理
1. 录制的请求流程

## 代理服务器录制原理

本篇文章主要了解代理服务器的原理，无论是JMeter自带的代理服务器还是第三方代理录制服务器。它是通过怎样的方式把客户端的操作请求生成对应的压测脚本。

简单画了一下原理图，根据原理图来给大家讲解一下对应的流程：

### 请求的发送

![](https://cdn.jsdelivr.net/gh/TesterDevSoul/pic/manual/20230202164929.png)

当客户端没有设置代理时，直接发送请求给服务端。

当开启代理服务器后，代理服务器就像屏幕录制功能一样，在客户端的所有操作都会无差别的记录下来。

代理服务器的**功能**：**请求的存储并转发**。

客户端发送的请求先发送给代理服务器，代理服务器存储后再把请求转发给服务端，请求内容不会进行任何的更改。


### 请求的结果返回

![](https://cdn.jsdelivr.net/gh/TesterDevSoul/pic/manual/20230203112219.png)

没有代理服务器时，服务端接收请求后，需要进行相关业务逻辑的处理，完成后需要再把响应结果返回给客户端。

当开启代理服务器后，代理服务器不只是对请求进行储存和转发，对应的响应也需要通过代理服务器返回给客户端。

### 场景

浏览器打开百度网页，在地址栏输入`www.baidu.com`域名后回车显示百度首页。

#### 无代理服务器请求流程

客户端「浏览器」直接发送请求给百度服务器。
对应服务器根据请求路径返回数据给客户端。

#### 代理服务器请求流程

客户端「浏览器」发送的请求**通过代理服务器**发送给百度服务器。

对应服务器根据请求的路径返回数据，然后再**通过代理服务器**返回给客户端。

### 注意事项

- 客户端配置代理设置后，发送的请求是通过代理服务器和服务端进行的通信。

- 客户端和代理服务器，代理服务器和服务端要能够通信。

- 客户端和代理服务器「`JMeter`」可以在同一台机器上{**JMeter录制Web脚本**}，也可以不在同一台机器上{**JMeter录制iOS脚本**}，只要在**同一个网络环境**下就可以。


### 代理服务器录制流程

无论是JMeter自身的代理服务器还是第三方的代理服务器，对应的流程大致如下：

1. 打开添加代理服务器相关组件。
2. 代理服务器进行相关配置：端口、脚本路径、编码格式等等。
3. 启动代理服务器，`JMeter`自身代理服务器会生成`CA`证书。
4. 客户端配置证书及相关代理配置。
5. 执行业务逻辑。
6. 录制结束，关闭代理服务器，脚本保存。

#### CA证书作用
`CA`「`Certificate Authority`」：**证书授权中心**，负责管理和签发证书的第三方机构。

一般，`CA`证书必须是所有行业和所有公众都信任的、认可的，因此它具有足够的权威性。`CA`证书就是权威机构颁发的证书。

在本文中，生成的`CA`证书就是客户端与`JMeter`代理服务器之间的相互认可的一个信用凭证。

## 代理服务器介绍

可以录制`JMeter`压测脚本的代理服务器分为**两**类： 一类为`JMeter`自带的**HTTP代理服务器**；一类为**借助第三方工具**，比如：`Blazemeter`。

- `Blazemeter`：是一个**云测平台**，有提供`Chrome`插件实现`Chrome`浏览器录制功能。

- `badboy`：只需要了解，基本弃用。

#### 优点

录制回放上手容易，入门学习的好手段。

首先录制出业务功能的接口信息，再基于录制后的脚本进行优化来提高接口自动化/压测脚本的效率。


## 总结

- 客户端需要进行相关设置
- 客户端通过代理服务器与被测服务进行通信

![](https://cdn.jsdelivr.net/gh/TesterDevSoul/pic/manual/20230205150648.png)