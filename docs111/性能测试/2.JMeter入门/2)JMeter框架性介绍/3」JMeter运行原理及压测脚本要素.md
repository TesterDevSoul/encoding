# JMeter运行原理及压测脚本要素

## 本章要点
1. JMeter运行原理
1. 压测脚本要素
1. 组件执行顺序

## JMeter运行原理

在上一篇文章我们了JMeter的组成部分，下面来了解一下对应的JMeter的运行原理。

用过LoadRunner的同学应该知道，对应的LoadRunner运行方式是可以选择的，可以选择时进程也可以选择是线程来运行脚本。JMeter选择的是线程方式来运行。

**为什么JMeter选择线程的方式来运行脚本？**

JMeter是Java语言开发的软件，所以它的压测脚本都是在JVM虚拟机上运行的，那对应的每个进程的开销就要比LoadRunner的进程开销大。

如果用进程的方式来运行的话，那每台负载机的进程数量就不允许有太多，所以JMeter选择以线程的方式来运行。

JMeter通过线程池「也就是线程组」来驱动多个线程，以此来运行测试脚本对被测服务发起负载。每一个负载机都可以运行多个线程组，如下图测试计划下可以有多个线程组。

![](https://cdn.jsdelivr.net/gh/TesterDevSoul/pic/manual/20230221115851.png)

JMeter编写的压测脚本运行不仅可以在GUI中运行，还可以使用JMeter的命令行运行，并且命令行运行对于负载机来说资源消耗会更小一些。

### 分布式

JMeter也支持远程运行，运行架构如下：

![](https://cdn.jsdelivr.net/gh/TesterDevSoul/pic/manual/20230221185918.png)

- **控制机**：多台JMeter负载机进行压测时，其中一个被选为管理的那台机器。控制机也可参与脚本运行，并且管理远程负载机（远程指挥负载机运行的任务并收集远程负载机的测试结果）。

- **负载机**：向被测服务器发起负载的机器。（控制机同时也是一台负载机）控制机会把要运行的压测脚本发给远程负载机，但是压测脚本中所需的参数文件及依赖的第三方jar包，控制机是不会发给远程负载机，需要自己用工具实现自动拷贝。



#### 运行逻辑
在多台电脑上，启动JMeter的Romote Testing模式，然后其中某一台负载机作为Master端「控制机」通过RMI控制Slave端来执行我们的测试脚本。当JMeter Slave端执行完测试脚本后，会将执行结果发送回Master控制端进行汇总，得出整体的测试报表。

JMeter的分布式的好处就是可以用一台终端、一个测试计划在多台服务器端同时对目标服务器进行测试，并且将测试的结果回报给统一的控制终端进行汇总，方便高并发的测试需求。

## 压测脚本要素
JMeter中一个脚本就是一个测试计划，也是一个管理单元。
### 测试计划
描述一个性能/接口测试脚本和对应的场景设计，包含该测试项目的所有相关功能。即，JMeter进行测试的所有内容都在一个测试计划中。「一个测试计划对应一个JMeter压测脚本。」

在JMeter中，一个脚本只能编辑一个测试计划。如果需要创建新的测试计划，则需要重新创建一个JMeter脚本。

### 要素一：一个JMeter脚本中测试计划只有一个。

JMeter中 GUI显示的是树形结构，测试计划是根节点，根节点只能有一个。一棵树只能有一个根。

### 要素二：测试计划中至少有一个线程组。

JMeter负载是线程组驱动的，所以测试计划中至少要出现一个线程组，JMeter的测试计划支持有多个线程组。

### 要素三：至少有一个取样器。

压测脚本的目的就是要模拟用户请求，如果压测脚本中没有取样器则脚本就没有意义，都没有意义了也无需谈论对错。

### 要素四：至少有一个监听器。

测试结果是用来衡量服务端性能的，需要从压测的结果中分析性能。

至于其他的组件，都是为以上要素进行服务的。至于哪些元件下能添加哪些元件，不需要担心，JMeter做了严格的控制。


## JMeter组件执行顺序

JMeter压测脚本中的组件是呈树形结构排列，测试计划下的组件之间的执行顺序是：
1. 先执行根节点，再执行子节点。
   >同一个作用范围内有多个同一类型组件，则这些组件按照测试计划中的顺序自上而下依次执行。
2. 在同一作用域范围内（同一层次），各个组件执行顺序逻辑：
	1. **配置元件**：影响作用范围内的所有组件。
	2. **前置处理器**：在作用范围内的**每个取样器**组件前执行。
	3. **定时器**：对作用范围内**每个取样器**有效。
	4. **取样器**
	5. **后置处理器**：在作用范围内**每个取样器**组件后执行。
	6. **断言**：对作用范围内**每个取样器**组件执行后的结果进行校验。
	7. **监听器**：收集作用范围内的**每个取样器**组件的相关信息并呈现出来。     

>以上很多组件都是跟取样器有关联，如果在作用范围内没有取样器，那对应组件则不会被执行，就没有意义。


## 总结
- 测试计划四要素。
- JMeter组件执行顺序： 先执行根节点，再执行子节点； 同一层次中，各个组件执行顺序逻辑： 【配置元件】 -->  【前置处理器】 --> 【定时器】 --> 【取样器】 --> 【后置处理器】 --> 【断言】 --> 【监听器】。


![](https://cdn.jsdelivr.net/gh/TesterDevSoul/pic/manual/20230222111833.png)